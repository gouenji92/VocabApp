<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>T·∫£i l√™n b·ªô t·ª´ - VocabApp</title>
  <link rel="stylesheet" href="/static/base.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      min-height: 100vh;
    }

    /* Header gi·ªëng Feed */
    .top-header {
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 12px 20px;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .logo {
      font-size: 1.8em;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-decoration: none;
    }

    .nav-icons {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .nav-btn {
      padding: 8px 16px;
      background: none;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95em;
      color: #333;
      text-decoration: none;
      transition: all 0.3s;
    }

    .nav-btn:hover {
      background: #f0f2f5;
    }

    .nav-btn.active {
      color: #667eea;
      font-weight: 600;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1em;
    }

    main { 
      max-width: 960px; 
      margin: 20px auto; 
      padding: 0 20px 40px; 
    }

    .page-header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .page-header h1 {
      font-size: 2em;
      color: #050505;
      margin-bottom: 8px;
    }

    .page-header p {
      color: #65676b;
      font-size: 0.95em;
      line-height: 1.6;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .section {
      margin-top: 24px;
    }

    label {
      display: block;
      font-weight: 600;
      color: #050505;
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    input[type="text"],
    input[type="file"],
    select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e4e6eb;
      border-radius: 8px;
      font-size: 0.95em;
      margin-bottom: 16px;
      transition: all 0.3s;
      font-family: inherit;
    }

    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    input[type="file"] {
      padding: 10px;
      cursor: pointer;
    }

    .btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      font-size: 0.95em;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-ghost {
      padding: 12px 24px;
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s;
      font-size: 0.95em;
    }

    .btn-ghost:hover {
      background: #667eea;
      color: white;
    }

    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      background: #e7f3ff;
      color: #1976d2;
      margin-bottom: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e4e6eb;
    }

    th {
      background: #f7f8fa;
      font-weight: 600;
      color: #050505;
    }

    .table {
      overflow: auto;
      border-radius: 12px;
      border: 1px solid #e4e6eb;
    }

    h2 {
      font-size: 1.5em;
      color: #050505;
      margin: 0 0 16px 0;
    }

    h3 {
      font-size: 1.2em;
      color: #050505;
      margin: 0 0 12px 0;
    }

    @media (max-width: 768px) {
      .nav-icons {
        gap: 8px;
      }

      main {
        padding: 0 16px 40px;
      }

      .page-header h1 {
        font-size: 1.5em;
      }

      .card {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Header gi·ªëng Feed -->
  <div class="top-header">
    <div class="header-content">
      <a href="/" class="logo">VocabApp</a>
      <div class="nav-icons">
        <a href="/feed" class="nav-btn">üè† Feed</a>
        <a href="/sets" class="nav-btn">üìö B·ªô t·ª´ c·ªßa t√¥i</a>
        <a href="/dashboard" class="nav-btn">üìä Th·ªëng k√™</a>
        <a href="/profile" class="nav-btn" title="T√†i kho·∫£n">
          {% if user and user.avatar %}
            <img src="{{ user.avatar }}" alt="Avatar" style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid #e5e7eb;" />
          {% else %}
            <div class="user-avatar" title="{{ username }}">{{ username[0].upper() }}</div>
          {% endif %}
        </a>
        <a href="/logout" class="nav-btn" style="color:#ef4444;">ƒêƒÉng xu·∫•t</a>
      </div>
    </div>
  </div>

  <main>
    <div class="page-header">
      <h1>üì§ T·∫£i l√™n b·ªô t·ª´ v·ª±ng</h1>
      <p>B∆∞·ªõc 1: Ch·ªçn file CSV/XLSX c√≥ header ‚Üí B∆∞·ªõc 2: Xem tr∆∞·ªõc & ƒëi·ªÅu ch·ªânh c·ªôt ‚Üí B∆∞·ªõc 3: Nh·∫≠p d·ªØ li·ªáu v√†o h·ªá th·ªëng</p>
    </div>

    <section class="card" id="step1">
      <form id="form-detect" enctype="multipart/form-data">
        <label>File d·ªØ li·ªáu (CSV/XLSX)</label>
        <input type="file" name="file" accept=".csv,.xlsx" required />

        <label>T√™n b·ªô t·ª´</label>
        <input type="text" name="set_name" placeholder="V√≠ d·ª•: 3000 t·ª´ th√¥ng d·ª•ng" required />

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
          <div>
            <label>Ng√¥n ng·ªØ g·ªëc</label>
            <input type="text" name="language_from" value="en" />
          </div>
          <div>
            <label>Ng√¥n ng·ªØ nghƒ©a</label>
            <input type="text" name="language_to" value="vi" />
          </div>
        </div>

        <div style="display:flex;gap:.75rem;">
          <button type="submit" class="btn">üîç Ph√¢n t√≠ch c·ªôt</button>
          <a href="/sets" class="btn-ghost">‚Üê Quay l·∫°i danh s√°ch</a>
        </div>
      </form>
    </section>

    <section class="card" id="step2" style="display:none;">
      <h2>B∆∞·ªõc 2: Xem tr∆∞·ªõc & Ch·ªçn c·ªôt</h2>
      <div id="preview-info" class="section"></div>

      <form id="form-import" enctype="multipart/form-data" class="section">
        <input type="hidden" name="set_name" />
        <input type="hidden" name="language_from" />
        <input type="hidden" name="language_to" />
        <input type="hidden" name="visibility" value="private" />

        <label>File g·ªëc (g·ª≠i l·∫°i)</label>
        <input type="file" name="file" accept=".csv,.xlsx" required />

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;">
          <div>
            <label>üî§ C·ªôt <strong>T·ª´ v·ª±ng</strong> (b·∫Øt bu·ªôc)</label>
            <select name="word_col" id="word_col" required></select>
          </div>
          <div>
            <label>üìñ C·ªôt <strong>Nghƒ©a</strong> (b·∫Øt bu·ªôc)</label>
            <select name="meaning_col" id="meaning_col" required></select>
          </div>
          <div>
            <label>üè∑Ô∏è C·ªôt <strong>Lo·∫°i t·ª´</strong> (tu·ª≥ ch·ªçn)</label>
            <select name="pos_col" id="pos_col"></select>
          </div>
        </div>

        <div style="margin-top:1rem;display:flex;gap:.75rem;">
          <button type="submit" class="btn">‚¨áÔ∏è Nh·∫≠p d·ªØ li·ªáu</button>
          <a href="/" class="btn-ghost">Ch·ªçn file kh√°c</a>
        </div>
      </form>

      <div id="sample-table" class="section"></div>
    </section>

    <section class="card" id="step3" style="display:none;">
      <h2>‚úÖ K·∫øt qu·∫£ nh·∫≠p</h2>
      <div id="import-result"></div>
    </section>
  </main>

  <script>
    const formDetect = document.getElementById('form-detect');
    const formImport = document.getElementById('form-import');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const previewInfo = document.getElementById('preview-info');
    const sampleTableDiv = document.getElementById('sample-table');

    formDetect.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(formDetect);
      const resp = await fetch('/preview', { method: 'POST', body: fd });
      if(!resp.ok){ alert('L·ªói ph√¢n t√≠ch'); return; }
      const data = await resp.json();
      step2.style.display = 'block';

      const sugWord = data.mapping.word || '(ch∆∞a ph√°t hi·ªán)';
      const sugMeaning = data.mapping.meaning || '(ch∆∞a ph√°t hi·ªán)';
      const sugPos = data.mapping.pos || '(kh√¥ng b·∫Øt bu·ªôc)';
      previewInfo.innerHTML = `<div class="badge badge-info">G·ª£i √Ω t·ª± ƒë·ªông</div>
        <div class='muted' style='margin-top:.5rem;'>
        ‚Ä¢ T·ª´ v·ª±ng: <strong>${sugWord}</strong><br/>
        ‚Ä¢ Nghƒ©a: <strong>${sugMeaning}</strong><br/>
        ‚Ä¢ Lo·∫°i t·ª´: <strong>${sugPos}</strong><br/>
        <em>B·∫°n c√≥ th·ªÉ thay ƒë·ªïi ·ªü dropdown b√™n d∆∞·ªõi n·∫øu kh√¥ng ƒë√∫ng.</em></div>`;

      formImport.querySelector('input[name=set_name]').value = data.set_name;
      formImport.querySelector('input[name=language_from]').value = data.language_from;
      formImport.querySelector('input[name=language_to]').value = data.language_to;

      const headers = data.headers || [];
      const fillSelect = (selId, selected) => {
        const sel = document.getElementById(selId);
        sel.innerHTML = '<option value="">-- Kh√¥ng ch·ªçn --</option>' + headers.map(h => `<option value="${h}" ${selected===h?'selected':''}>${h}</option>`).join('');
      };
      fillSelect('word_col', data.mapping.word);
      fillSelect('meaning_col', data.mapping.meaning);
      fillSelect('pos_col', data.mapping.pos);

      if(Array.isArray(data.sample) && data.sample.length){
        let html = '<h3 style="margin-top:0;">Xem tr∆∞·ªõc d·ªØ li·ªáu (5 d√≤ng ƒë·∫ßu)</h3><div class="table border" style="overflow:auto; border-radius:12px;"><table style="width:100%; border-collapse:collapse;">\n<thead><tr>';
        const cols = Object.keys(data.sample[0]);
        for(const c of cols){ 
          let badge = '';
          if(c === data.mapping.word) badge = ' üî§';
          if(c === data.mapping.meaning) badge = ' üìñ';
          if(c === data.mapping.pos) badge = ' üè∑Ô∏è';
          html += `<th style="border-bottom:1px solid var(--border);text-align:left;">${c}${badge}</th>`; 
        }
        html += '</tr></thead><tbody>';
        for(const row of data.sample){
          html += '<tr>' + cols.map(c => `<td style="border-bottom:1px solid var(--border);">${row[c]}</td>`).join('') + '</tr>';
        }
        html += '</tbody></table></div>';
        sampleTableDiv.innerHTML = html;
      }
      window.scrollTo({ top: step2.offsetTop - 16, behavior: 'smooth' });
    });

    formImport.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(formImport);
      const resp = await fetch('/import', { method: 'POST', body: fd });
      if(!resp.ok){ alert('L·ªói import'); return; }
      const data = await resp.json();
      if(data.error){ alert(data.error); return; }
      step3.style.display = 'block';
      document.getElementById('import-result').innerHTML = `
        <p>‚úÖ <strong>Nh·∫≠p th√†nh c√¥ng!</strong></p>
        <p>ƒê√£ th√™m ${data.inserted} t·ª´ (b·ªè qua ${data.skipped} d√≤ng r·ªóng)</p>
        <div style="margin-top:1rem;display:flex;gap:.5rem;flex-wrap:wrap;">
          <a href="/sets/${data.set_id}" class="btn">üìñ Xem chi ti·∫øt b·ªô t·ª´</a>
          <a href="/study/${data.set_id}?mode=select" class="btn" style="background:var(--success);">üéØ H·ªçc ngay</a>
          <a href="/sets" class="btn-ghost">üìö Xem t·∫•t c·∫£ b·ªô t·ª´</a>
        </div>
      `;
      window.scrollTo({ top: step3.offsetTop - 16, behavior: 'smooth' });
    });
  </script>
</body>
</html>
