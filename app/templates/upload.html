<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>T·∫£i l√™n b·ªô t·ª´ - VocabApp</title>
  <link rel="stylesheet" href="/static/base.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      min-height: 100vh;
    }

    /* Header styles centralized in /static/base.css */

    main { 
      max-width: 960px; 
      margin: 20px auto; 
      padding: 0 20px 40px; 
    }

    .page-header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .page-header h1 {
      font-size: 2em;
      color: #050505;
      margin-bottom: 8px;
    }

    .page-header p {
      color: #65676b;
      font-size: 0.95em;
      line-height: 1.6;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .section {
      margin-top: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      color: #050505;
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    input[type="text"],
    input[type="file"],
    select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e4e6eb;
      border-radius: 8px;
      font-size: 0.95em;
      margin-bottom: 16px;
      transition: all 0.3s;
      font-family: inherit;
    }

    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    input[type="file"] {
      padding: 10px;
      cursor: pointer;
    }

    .btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      font-size: 0.95em;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-ghost {
      padding: 12px 24px;
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s;
      font-size: 0.95em;
    }

    .btn-ghost:hover {
      background: #667eea;
      color: white;
    }

    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      background: #e7f3ff;
      color: #1976d2;
      margin-bottom: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e4e6eb;
    }

    th {
      background: #f7f8fa;
      font-weight: 600;
      color: #050505;
    }

    .table {
      overflow: auto;
      border-radius: 12px;
      border: 1px solid #e4e6eb;
    }

    h2 {
      font-size: 1.5em;
      color: #050505;
      margin: 0 0 16px 0;
    }

    h3 {
      font-size: 1.2em;
      color: #050505;
      margin: 0 0 12px 0;
    }

    /* Upload component styles centralized in /static/base.css */

    @media (max-width: 768px) {
      .nav-icons {
        gap: 8px;
      }

      main {
        padding: 0 16px 40px;
      }

      .page-header h1 {
        font-size: 1.5em;
      }

      .card {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Header gi·ªëng Feed -->
  <div class="top-header">
    <div class="header-content">
      <a href="/" class="logo">VocabApp</a>
      <div class="nav-icons">
        <a href="/feed" class="nav-btn" title="Feed">
          <svg class="icon" width="22" height="22" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 15L24 4L42 15V40C42 41.1046 41.1046 42 40 42H8C6.89543 42 6 41.1046 6 40V15Z" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 42V24H31V42" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Feed
        </a>
        <a href="/sets" class="nav-btn" title="B·ªô t·ª´ c·ªßa t√¥i">
          <svg class="icon" width="22" height="22" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 8H32V40H8V8Z" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/><path d="M32 8H40V40H32" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
          B·ªô t·ª´
        </a>
        <a href="/dashboard" class="nav-btn" title="Th·ªëng k√™">
          <svg class="icon" width="22" height="22" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 42V18" stroke="currentColor" stroke-width="3" stroke-linecap="round"/><path d="M18 42V6" stroke="currentColor" stroke-width="3" stroke-linecap="round"/><path d="M30 42V26" stroke="currentColor" stroke-width="3" stroke-linecap="round"/><path d="M42 42V12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>
          Th·ªëng k√™
        </a>
        <a href="/profile" class="nav-btn" title="T√†i kho·∫£n">
          <svg class="icon" width="22" height="22" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="24" cy="12" r="8" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/><path d="M42 44C42 34.0589 33.9411 26 24 26C14.0589 26 6 34.0589 6 44" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
          T√†i kho·∫£n
        </a>
        {% if user and user.avatar %}
        <img src="{{ user.avatar }}" class="user-avatar-img" title="{{ user.display_name or username }}" />
        {% else %}
        <div class="user-avatar" title="{{ user.display_name if user else username }}">{{ username[0].upper() }}</div>
        {% endif %}
        <a href="/logout" class="nav-btn logout" title="ƒêƒÉng xu·∫•t">ƒêƒÉng xu·∫•t</a></div>
    </div>
  </div>

  <div class="back-button-container">
    <button onclick="history.back()" class="back-button">
      <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 8L5 16L13 24" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 16H27C35 16 41 22 41 30C41 38 35 44 27 44H21" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Quay l·∫°i
    </button>
  </div>

  <main>
    <div class="page-header">
  <h1><span class="iconify icon-upload icon-24 icon-gradient-accent" style="margin-right:8px;"></span>T·∫£i l√™n b·ªô t·ª´ v·ª±ng</h1>
      <p>B∆∞·ªõc 1: Ch·ªçn file CSV/XLSX c√≥ header ‚Üí B∆∞·ªõc 2: Xem tr∆∞·ªõc & ƒëi·ªÅu ch·ªânh c·ªôt ‚Üí B∆∞·ªõc 3: Nh·∫≠p d·ªØ li·ªáu v√†o h·ªá th·ªëng</p>
    </div>

    <section class="card" id="step1">
      <form id="form-detect" enctype="multipart/form-data">
        <label>File d·ªØ li·ªáu (CSV/XLSX)</label>
        <label class="custum-file-upload">
          <div class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="80" height="80"><path d="M19 15v4a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><polyline points="16 10 12 6 8 10" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="12" y1="6" x2="12" y2="20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <div class="text"><span>Ch·ªçn ho·∫∑c k√©o th·∫£ file CSV/XLSX</span></div>
          <input id="file-upload" type="file" name="file" accept=".csv,.xlsx" required />
        </label>

        <label>T√™n b·ªô t·ª´</label>
        <input type="text" name="set_name" placeholder="V√≠ d·ª•: 3000 t·ª´ th√¥ng d·ª•ng" required />

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
          <div>
            <label>Ng√¥n ng·ªØ g·ªëc</label>
            <input type="text" name="language_from" value="en" />
          </div>
          <div>
            <label>Ng√¥n ng·ªØ nghƒ©a</label>
            <input type="text" name="language_to" value="vi" />
          </div>
        </div>

        <div style="display:flex;gap:.75rem;">
          <button type="submit" class="btn"><span class="iconify icon-search icon-16" style="margin-right:6px;"></span>Ph√¢n t√≠ch c·ªôt</button>
          <a href="/sets" class="btn-ghost">‚Üê Quay l·∫°i danh s√°ch</a>
        </div>
      </form>
    </section>

    <section class="card" id="step2" style="display:none;">
      <h2>B∆∞·ªõc 2: Xem tr∆∞·ªõc & Ch·ªçn c·ªôt</h2>
      <div id="preview-info" class="section"></div>

      <form id="form-import" enctype="multipart/form-data" class="section">
        <input type="hidden" name="set_name" />
        <input type="hidden" name="language_from" />
        <input type="hidden" name="language_to" />
        <input type="hidden" name="visibility" value="private" />

        <label>File g·ªëc (g·ª≠i l·∫°i)</label>
        <label class="custum-file-upload">
          <div class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="80" height="80"><path d="M19 15v4a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><polyline points="16 10 12 6 8 10" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="12" y1="6" x2="12" y2="20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <div class="text"><span>Ch·ªçn l·∫°i file CSV/XLSX ƒë·ªÉ nh·∫≠p</span></div>
          <input id="file-upload-2" type="file" name="file" accept=".csv,.xlsx" required />
        </label>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;">
          <div>
            <label><span class="iconify icon-note icon-14 icon-gradient-accent" style="margin-right:4px;"></span>C·ªôt <strong>T·ª´ v·ª±ng</strong> (b·∫Øt bu·ªôc)</label>
            <select name="word_col" id="word_col" required></select>
          </div>
          <div>
            <label><span class="iconify icon-book icon-14 icon-gradient-accent" style="margin-right:4px;"></span>C·ªôt <strong>Nghƒ©a</strong> (b·∫Øt bu·ªôc)</label>
            <select name="meaning_col" id="meaning_col" required></select>
          </div>
          <div>
            <label><span class="iconify icon-tag icon-14 icon-gradient-accent" style="margin-right:4px;"></span>C·ªôt <strong>Lo·∫°i t·ª´</strong> (tu·ª≥ ch·ªçn)</label>
            <select name="pos_col" id="pos_col"></select>
          </div>
          <div>
            <label><span class="iconify icon-voice icon-14 icon-gradient-accent" style="margin-right:4px;"></span>C·ªôt <strong>Phi√™n √¢m</strong> (tu·ª≥ ch·ªçn)</label>
            <select name="pronunciation_col" id="pronunciation_col"></select>
          </div>
          <div>
            <label><span class="iconify icon-message icon-14 icon-gradient-accent" style="margin-right:4px;"></span>C·ªôt <strong>V√≠ d·ª•</strong> (tu·ª≥ ch·ªçn)</label>
            <select name="example_col" id="example_col"></select>
          </div>
        </div>

        <div style="margin-top:1rem;display:flex;gap:.75rem;">
          <button type="submit" class="btn"><span class="iconify icon-download icon-16" style="margin-right:6px;"></span>Nh·∫≠p d·ªØ li·ªáu</button>
          <a href="/" class="btn-ghost">Ch·ªçn file kh√°c</a>
        </div>
      </form>

      <div id="sample-table" class="section"></div>
    </section>

    <section class="card" id="step3" style="display:none;">
      <h2>‚úÖ K·∫øt qu·∫£ nh·∫≠p</h2>
      <div id="import-result"></div>
    </section>
  </main>

  <script src="/static/file_upload.js"></script>
  <script>
    const formDetect = document.getElementById('form-detect');
    const formImport = document.getElementById('form-import');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const previewInfo = document.getElementById('preview-info');
    const sampleTableDiv = document.getElementById('sample-table');

  formDetect.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(formDetect);
      const resp = await fetch('/preview', { method: 'POST', body: fd });
      if(!resp.ok){ alert('L·ªói ph√¢n t√≠ch'); return; }
      const data = await resp.json();
      step2.style.display = 'block';

      const sugWord = data.mapping.word || '(ch∆∞a ph√°t hi·ªán)';
      const sugMeaning = data.mapping.meaning || '(ch∆∞a ph√°t hi·ªán)';
      const sugPos = data.mapping.pos || '(kh√¥ng b·∫Øt bu·ªôc)';
      const sugPronunciation = data.mapping.pronunciation || '(kh√¥ng b·∫Øt bu·ªôc)';
      const sugExample = data.mapping.example || '(kh√¥ng b·∫Øt bu·ªôc)';
      previewInfo.innerHTML = `<div class="badge badge-info">G·ª£i √Ω t·ª± ƒë·ªông</div>
        <div class='muted' style='margin-top:.5rem;'>
        ‚Ä¢ T·ª´ v·ª±ng: <strong>${sugWord}</strong><br/>
        ‚Ä¢ Nghƒ©a: <strong>${sugMeaning}</strong><br/>
        ‚Ä¢ Lo·∫°i t·ª´: <strong>${sugPos}</strong><br/>
        ‚Ä¢ Phi√™n √¢m: <strong>${sugPronunciation}</strong><br/>
        ‚Ä¢ V√≠ d·ª•: <strong>${sugExample}</strong><br/>
        <em>B·∫°n c√≥ th·ªÉ thay ƒë·ªïi ·ªü dropdown b√™n d∆∞·ªõi n·∫øu kh√¥ng ƒë√∫ng.</em></div>`;

      formImport.querySelector('input[name=set_name]').value = data.set_name;
      formImport.querySelector('input[name=language_from]').value = data.language_from;
      formImport.querySelector('input[name=language_to]').value = data.language_to;

      const headers = data.headers || [];
      const fillSelect = (selId, selected) => {
        const sel = document.getElementById(selId);
        sel.innerHTML = '<option value="">-- Kh√¥ng ch·ªçn --</option>' + headers.map(h => `<option value="${h}" ${selected===h?'selected':''}>${h}</option>`).join('');
      };
      fillSelect('word_col', data.mapping.word);
      fillSelect('meaning_col', data.mapping.meaning);
      fillSelect('pos_col', data.mapping.pos);
      fillSelect('pronunciation_col', data.mapping.pronunciation);
      fillSelect('example_col', data.mapping.example);

      if(Array.isArray(data.sample) && data.sample.length){
        let html = '<h3 style="margin-top:0;">Xem tr∆∞·ªõc d·ªØ li·ªáu (5 d√≤ng ƒë·∫ßu)</h3><div class="table border" style="overflow:auto; border-radius:12px;"><table style="width:100%; border-collapse:collapse;">\n<thead><tr>';
        const cols = Object.keys(data.sample[0]);
        for(const c of cols){ 
          let badge = '';
          if(c === data.mapping.word) badge = ' üî§';
          if(c === data.mapping.meaning) badge = ' üìñ';
          if(c === data.mapping.pos) badge = ' üè∑Ô∏è';
          if(c === data.mapping.pronunciation) badge = ' üó£Ô∏è';
          if(c === data.mapping.example) badge = ' üí¨';
          html += `<th style="border-bottom:1px solid var(--border);text-align:left;">${c}${badge}</th>`; 
        }
        html += '</tr></thead><tbody>';
        for(const row of data.sample){
          html += '<tr>' + cols.map(c => `<td style="border-bottom:1px solid var(--border);">${row[c]}</td>`).join('') + '</tr>';
        }
        html += '</tbody></table></div>';
        sampleTableDiv.innerHTML = html;
      }
      window.scrollTo({ top: step2.offsetTop - 16, behavior: 'smooth' });
    });

  formImport.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(formImport);
      const resp = await fetch('/import', { method: 'POST', body: fd });
      if(!resp.ok){ alert('L·ªói import'); return; }
      const data = await resp.json();
      if(data.error){ alert(data.error); return; }
      step3.style.display = 'block';
      document.getElementById('import-result').innerHTML = `
  <p><span class="iconify icon-check icon-18 icon-success" style="margin-right:6px;"></span><strong>Nh·∫≠p th√†nh c√¥ng!</strong></p>
        <p>ƒê√£ th√™m ${data.inserted} t·ª´ (b·ªè qua ${data.skipped} d√≤ng r·ªóng)</p>
        <div style="margin-top:1rem;display:flex;gap:.5rem;flex-wrap:wrap;">
          <a href="/sets/${data.set_id}" class="btn"><span class="iconify icon-book icon-16" style="margin-right:6px;"></span>Xem chi ti·∫øt b·ªô t·ª´</a>
          <a href="/study/${data.set_id}?mode=select" class="btn" style="background:var(--success);"><span class="iconify icon-target icon-16" style="margin-right:6px;"></span>H·ªçc ngay</a>
          <a href="/sets" class="btn-ghost"><span class="iconify icon-collection icon-16 icon-gradient-accent" style="margin-right:6px;"></span>Xem t·∫•t c·∫£ b·ªô t·ª´</a>
        </div>
      `;
      window.scrollTo({ top: step3.offsetTop - 16, behavior: 'smooth' });
    });
  </script>
</body>
</html>



